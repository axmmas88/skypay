<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ - Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --primary: #2962ff;
      --bg: #f4f7fa;
      --surface: #ffffff;
      --text: #2c3e50;
      --border: #e0e6ed;
      --success: #00c853;
      --danger: #d50000;
    }

    * { box-sizing: border-box; outline: none; }
    body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
    
    .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
    
    /* AUTH Styles */
    #login-view { 
        display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
        background: var(--primary); color: #fff; text-align: center;
    }
    .login-card { 
        background: var(--surface); padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
        width: 350px; color: var(--text);
    }
    .login-card h2 { color: var(--primary); margin-bottom: 25px; }
    .login-card input { 
        margin-bottom: 15px; 
        padding: 12px; 
        width: 100%; 
        border: 1px solid var(--border);
    }
    .login-card .btn-primary { width: 100%; margin-top: 10px; }

    /* Admin/Courier Header */
    header { 
        background: var(--surface); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; 
    }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 20px; color: var(--primary); }
    .user-info { font-size: 14px; color: #7f8c8d; display: flex; align-items: center; gap: 15px; }
    .user-info .btn-sm { margin-right: 10px; }
    
    .nav-btn { background: none; border: none; font-size: 16px; color: #7f8c8d; cursor: pointer; padding: 10px; font-family: inherit; font-weight: 500; }
    .nav-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

    /* Common Styles */
    .card { background: var(--surface); border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.03); padding: 20px; margin-bottom: 20px; }
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    .form-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
    .input-group { flex: 1; min-width: 180px; }
    .input-group label { display: block; margin-bottom: 8px; font-size: 13px; color: #7f8c8d; }
    input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; background: #f8f9fa; }
    input:focus, select:focus { border-color: var(--primary); background: #fff; }

    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: right; padding: 15px; background: #f8f9fa; color: #7f8c8d; font-size: 13px; }
    td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
    
    tr.row-delivery { background-color: #e3f2fd; } 
    tr.row-deposit { background-color: #fff9c4; } 
    tr.row-delivery:hover { background-color: #bbdefb; }
    tr.row-deposit:hover { background-color: #fff59d; }

    .money-pill { font-weight: 700; padding: 4px 8px; border-radius: 4px; font-size: 15px; }
    .money-pos { color: var(--danger); background: #ffebee; }
    .money-neg { color: var(--success); background: #e8f5e9; }

    #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #323232; color: #fff; padding: 12px 25px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999; }
    #toast.show { opacity: 1; bottom: 50px; }
    .hidden { display: none !important; }

  </style>
</head>
<body>

  <div id="login-view">
    <div class="login-card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</h2>
        <input type="text" id="loginUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Admin Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨)" />
        <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <button class="btn btn-primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="app-view" class="hidden">
    
    <header>
        <div class="brand"><i class="material-icons">local_shipping</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª</div>
        <div class="user-info">
            <span id="welcome-message"></span>
            <div id="nav-container">
                </div>
            <button class="btn btn-sm" style="background:#f44336; color:#fff;" onclick="logout()">
                <i class="material-icons" style="font-size:16px">logout</i> Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </header>

    <div class="container">
        <div id="toast">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</div>

        <div id="admin-view" class="hidden">
            <div id="tab-orders">
                <div class="card">...</div> </div>
            <div id="tab-couriers" class="hidden">
                <div class="card">...</div> </div>
        </div>

        <div id="courier-view" class="hidden">
            <div class="card">
                <div class="section-title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙƒ</div>
                <div style="overflow-x:auto">
                    <table id="courierOrdersTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                                <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
                                <th>Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>

  <iframe id="printFrame" style="display:none"></iframe>

<div class="hidden" id="admin-form-templates">
<div id="admin-order-form">
    <div class="card">
        <div class="section-title"><i class="material-icons" style="color:var(--primary)">add_circle</i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ / Ø¹Ø±Ø¨ÙˆÙ†</div>
        <div class="form-row">
            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                <select id="ordType" style="font-weight:bold">
                    <option value="delivery">ğŸšš ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨ÙŠØ©</option>
                    <option value="deposit">ğŸ’° Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ø±Ø¨ÙˆÙ†</option>
                </select>
            </div>
            <div class="input-group"><label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input id="ordCode" placeholder="ORD-001"></div>
            <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label><input id="ordName" placeholder="Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"></div>
            <div class="input-group"><label>ÙƒÙˆØ¯ Ø§Ù„Ø²Ø¨ÙˆÙ†</label><input id="ordCustCode" placeholder="C-100"></div>
            <div class="input-group"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="ordPhone"></div>
            <div class="input-group" style="flex:2"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="ordAddr"></div>
        </div>
        <div class="form-row" style="margin-top:15px">
            <div class="input-group"><label>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¯.Ù„)</label><input type="number" id="ordVal" value="0"></div>
            <div class="input-group">
                <label>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <select id="ordCourier"><option value="">-- Ø§Ø®ØªØ± --</option></select>
            </div>
            <div style="width:150px">
                <button class="btn btn-primary" style="width:100%; height:46px" onclick="addOrder()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>
<div id="admin-orders-list">
    <div class="card">
        <div class="section-title" style="justify-content: space-between;">
            <span>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
            <div class="controls">
                <select id="filterType" onchange="renderOrders()" style="width:150px; padding:6px">
                    <option value="all">Ø§Ù„ÙƒÙ„</option>
                    <option value="delivery">ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨ÙŠØ©</option>
                    <option value="deposit">Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ø±Ø¨ÙˆÙ†</option>
                </select>
                <input type="text" id="search" placeholder="Ø¨Ø­Ø«..." style="width:200px; padding:6px" onkeyup="renderOrders()">
            </div>
        </div>
        <div style="overflow-x:auto">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø·Ø¨Ø§Ø¹Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        <th>Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<div id="admin-courier-add">
    <div class="card">
        <div class="section-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¬Ø¯ÙŠØ¯ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div class="form-row">
            <div class="input-group"><input id="courCode" placeholder="ÙƒÙˆØ¯ (Ù…Ø«Ø§Ù„ D1)"></div>
            <div class="input-group"><input id="courName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
            <div class="input-group"><input id="courUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¯Ø®ÙˆÙ„)"></div>
            <div class="input-group"><input id="courPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
            <button class="btn btn-primary" onclick="addCourier()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>
</div>
<div id="admin-courier-accounts">
    <div class="card">
        <div class="section-title">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø®Ø²ÙŠÙ†Ø©</div>
        
        <div style="background:#e3f2fd; padding:20px; border-radius:8px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:14px; color:#555">Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø®Ø²ÙŠÙ†Ø©)</div>
                <div style="font-size:28px; font-weight:bold; color:var(--primary)"><span id="officeTotal">0.00</span> Ø¯.Ù„</div>
            </div>
            <button class="btn btn-sm" style="background:#e8f0fe; border:1px solid var(--primary); color:var(--primary)" onclick="adjustTreasury()">
                <i class="material-icons" style="font-size:16px">edit</i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© (Ø³Ø­Ø¨/Ø¥ÙŠØ¯Ø§Ø¹)
            </button>
        </div>

        <table id="couriersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø¹Ù‡Ø¯Ø© (Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ù‡)</th>
                    <th>Ù…Ø³ØªØ­Ù‚Ø§Øª (Ù„Ù‡)</th>
                    <th>ØªØµÙÙŠØ©</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>
<script>
// ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
const DB = 'delivery_sys_v5';
const ADMIN_USER = 'Admin';
const ADMIN_PASS = '12345'; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§

let state = { 
    orders: [], 
    couriers: [], 
    officeCash: 0,
    currentUser: null,
    isLoggedIn: false
};

function load() {
    const s = localStorage.getItem(DB);
    if(s) state = JSON.parse(s);
    
    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
    if (state.currentUser) {
        state.isLoggedIn = true;
    }
    renderApp();
}
function save() { 
    localStorage.setItem(DB, JSON.stringify(state)); 
    renderApp(); 
}
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2500);
}

// ==================== ÙˆØ¸Ø§Ø¦Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ====================

function login() {
    const user = document.getElementById('loginUsername').value.trim();
    const pass = document.getElementById('loginPassword').value.trim();

    // 1. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„
    if (user === ADMIN_USER && pass === ADMIN_PASS) {
        state.currentUser = { name: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„', role: 'admin' };
        state.isLoggedIn = true;
        save();
        toast('Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„');
    } 
    // 2. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ù†Ø¯ÙˆØ¨
    else {
        const courier = state.couriers.find(c => c.username === user && c.password === pass);
        if (courier) {
            state.currentUser = { name: courier.name, code: courier.code, role: 'courier' };
            state.isLoggedIn = true;
            save();
            toast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${courier.name}`);
        } else {
            alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­.');
        }
    }
}

function logout() {
    state.currentUser = null;
    state.isLoggedIn = false;
    save();
    window.location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø©
}

function renderApp() {
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('app-view').classList.add('hidden');
    document.getElementById('admin-view').classList.add('hidden');
    document.getElementById('courier-view').classList.add('hidden');

    if (!state.isLoggedIn || !state.currentUser) {
        document.getElementById('login-view').classList.remove('hidden');
        return;
    }

    document.getElementById('app-view').classList.remove('hidden');
    document.getElementById('welcome-message').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${state.currentUser.name}`;

    if (state.currentUser.role === 'admin') {
        renderAdminView();
    } else if (state.currentUser.role === 'courier') {
        renderCourierView();
    }
}

// ==================== Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ====================

function renderAdminView() {
    document.getElementById('admin-view').classList.remove('hidden');
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§
    document.getElementById('tab-orders').innerHTML = document.getElementById('admin-order-form').innerHTML + document.getElementById('admin-orders-list').innerHTML;
    document.getElementById('tab-couriers').innerHTML = document.getElementById('admin-courier-add').innerHTML + document.getElementById('admin-courier-accounts').innerHTML;

    // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (Tabs)
    document.getElementById('nav-container').innerHTML = `
        <button class="nav-btn active" onclick="showAdminTab('orders', this)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="nav-btn" onclick="showAdminTab('couriers', this)">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</button>
    `;
    showAdminTab('orders', document.querySelector('#nav-container .nav-btn.active')); // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
    renderAllAdminData();
}

function showAdminTab(tab, element) {
    document.getElementById('tab-orders').classList.add('hidden');
    document.getElementById('tab-couriers').classList.add('hidden');
    document.getElementById('tab-' + tab).classList.remove('hidden');
    
    document.querySelectorAll('#nav-container .nav-btn').forEach(b => b.classList.remove('active'));
    element.classList.add('active');
}

function renderAllAdminData() {
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
    const select = document.getElementById('ordCourier');
    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>' + 
        state.couriers.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
    
    renderOrders();
    renderCouriers();
    document.getElementById('officeTotal').innerText = state.officeCash.toFixed(2);
}

// (ÙˆØ¸Ø§Ø¦Ù Admin Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: renderOrders, renderCouriers, addCourier, addOrder, settleOrder, etc.)
// ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¹Ù„Ù‰ addCourier Ù„ÙŠÙ‚Ø¨Ù„ Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.
function addCourier() {
    const code = document.getElementById('courCode').value.trim();
    const name = document.getElementById('courName').value.trim();
    const username = document.getElementById('courUsername').value.trim();
    const password = document.getElementById('courPassword').value.trim();

    if(!code || !name || !username || !password) return alert('ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
    if(state.couriers.find(c=>c.code===code)) return alert('Ø§Ù„ÙƒÙˆØ¯ Ù…ÙƒØ±Ø±');
    if(state.couriers.find(c=>c.username===username) || username === ADMIN_USER) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ²');
    
    state.couriers.push({code, name, username, password, debt:0, earnings:0}); 
    document.getElementById('courCode').value=''; document.getElementById('courName').value='';
    document.getElementById('courUsername').value=''; document.getElementById('courPassword').value='';
    save(); toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨');
}
// ... Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù Admin (renderOrders, settleOrder, markDelivered...) ÙŠØªÙ… Ø¥Ø¨Ù‚Ø§Ø¤Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.

// ==================== Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ====================

function renderCourierView() {
    document.getElementById('courier-view').classList.remove('hidden');
    document.getElementById('nav-container').innerHTML = ''; // Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ù‚Ù„Ø§Øª Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨

    const courierCode = state.currentUser.code;
    
    // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆÙ„Ù… ÙŠÙ‚Ù… Ø¨ØªÙˆØµÙŠÙ„Ù‡Ø§ Ù„Ù„Ù…ÙƒØªØ¨ Ø¨Ø¹Ø¯
    const assignedOrders = state.orders.filter(o => 
        o.courier === courierCode && o.status !== 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…ÙƒØªØ¨'
    );
    
    const tbody = document.querySelector('#courierOrdersTable tbody');

    tbody.innerHTML = assignedOrders.map(o => {
        const statusLabel = o.status === 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨' ? 'Ù„Ù… ØªØ³ØªÙ„Ù… Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨ Ø¨Ø¹Ø¯' : 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…Ø³ØªÙ„Ù…)';
        let actionBtn = '';

        // Ø§Ù„Ø²Ø± ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³ØªÙ„Ù…Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨ Ø¨Ø¹Ø¯
        if(o.status === 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨') {
            actionBtn = `<button class="btn btn-sm btn-primary" onclick="courierReceiveParcel('${o.code}')">Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ø´Ø­Ù†Ø© Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨</button>`;
        } else {
             actionBtn = `<span style="color:${o.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' ? 'green' : 'orange'}">${statusLabel}</span>`;
        }

        const rowClass = o.type === 'deposit' ? 'row-deposit' : 'row-delivery';

        return `
        <tr class="${rowClass}">
            <td><strong>${o.code}</strong></td>
            <td>${o.type === 'deposit' ? 'ğŸ’° Ø¹Ø±Ø¨ÙˆÙ†' : 'ğŸšš ØªÙˆØµÙŠÙ„'}</td>
            <td><strong>${o.val} Ø¯.Ù„</strong></td>
            <td>${o.addr}</td>
            <td>${o.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
            <td>${actionBtn}</td>
        </tr>`;
    }).join('');
}

// Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„ÙˆØ­ÙŠØ¯: ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø´Ø­Ù†Ø© Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨
function courierReceiveParcel(orderCode) {
    const order = state.orders.find(o => o.code === orderCode);
    if (order.courier !== state.currentUser.code) return; // Ø­Ù…Ø§ÙŠØ©

    order.status = 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…Ø³ØªÙ„Ù…)';
    save();
    toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');
}


// ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù€ Admin Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ V4) ====================
// (ÙŠØªÙ… Ù†Ø³Ø®Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)

function adjustTreasury() {
    const amountStr = prompt("Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:\n(Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨ Ù„Ù„Ø¥Ø¶Ø§ÙØ©)\n(Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø³Ø§Ù„Ø¨ - Ù„Ù„Ø³Ø­Ø¨)", "0");
    const amount = parseFloat(amountStr);
    if(isNaN(amount) || amount === 0) return;
    state.officeCash += amount;
    save();
    toast(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©`);
}

function addOrder() {
    const type = document.getElementById('ordType').value; 
    const code = document.getElementById('ordCode').value.trim();
    const name = document.getElementById('ordName').value.trim();
    const custCode = document.getElementById('ordCustCode').value.trim();
    const phone = document.getElementById('ordPhone').value.trim();
    const addr = document.getElementById('ordAddr').value.trim();
    const val = parseFloat(document.getElementById('ordVal').value) || 0;
    const courierCode = document.getElementById('ordCourier').value;

    if(!code || !name) return alert('Ù…Ø·Ù„ÙˆØ¨ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†');
    if(state.orders.find(o=>o.code===code)) return alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ÙƒØ±Ø±Ø©');

    state.orders.push({
        type, code, name, custCode, phone, addr, val,
        courier: courierCode || null,
        status: courierCode ? 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨' : 'Ø¬Ø¯ÙŠØ¯',
        collected: 0
    });
    
    document.getElementById('ordCode').value=''; document.getElementById('ordName').value=''; 
    document.getElementById('ordCustCode').value=''; document.getElementById('ordPhone').value='';
    document.getElementById('ordAddr').value=''; document.getElementById('ordVal').value='0';
    
    save(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
}

function markDelivered(orderCode) {
    const order = state.orders.find(o => o.code === orderCode);
    const courier = state.couriers.find(c => c.code === order.courier);
    if(!courier) return alert('Ø­Ø¯Ø¯ Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹!');

    const amount = parseFloat(prompt(`Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${order.val}):`, order.val));
    if(isNaN(amount)) return;

    order.collected = amount;
    order.status = 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„';
    courier.debt += amount;
    save(); toast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨');
}

function settleOrder(orderCode) {
    const order = state.orders.find(o => o.code === orderCode);
    const courier = state.couriers.find(c => c.code === order.courier);
    if(!courier) return;

    courier.debt = Math.max(0, courier.debt - order.collected);
    state.officeCash += order.collected;

    const fee = parseFloat(prompt('Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:', '10')) || 0;
    courier.earnings += fee;

    order.status = 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…ÙƒØªØ¨';
    save(); toast('ØªÙ…Øª Ø§Ù„ØªØµÙÙŠØ©');
}

function assignCourier(orderCode) {
    const code = prompt('ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:');
    const courier = state.couriers.find(c => c.code === code);
    if(courier) {
        const o = state.orders.find(x=>x.code===orderCode);
        o.courier = courier.code; o.status = 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨';
        save();
    } else { alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); }
}

function deleteOrder(code) {
    if(!confirm('Ø­Ø°ÙØŸ')) return;
    const o = state.orders.find(x=>x.code===code);
    if(o.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' && o.courier) {
        const c = state.couriers.find(x=>x.code === o.courier);
        if(c) c.debt = Math.max(0, c.debt - o.collected);
    }
    state.orders = state.orders.filter(x => x.code !== code);
    save();
}

function payCourier(cCode) {
    const c = state.couriers.find(x=>x.code === cCode);
    if(c.earnings <= 0) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯');
    if(confirm(`ØµØ±Ù ${c.earnings} Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ`)) { c.earnings = 0; save(); }
}

function renderOrders() {
    const tbody = document.querySelector('#ordersTable tbody');
    const search = document.getElementById('search').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;

    const filtered = state.orders.filter(o => {
        const matchText = o.code.toLowerCase().includes(search) || o.name.includes(search);
        const matchType = filterType === 'all' || o.type === filterType;
        return matchText && matchType;
    });
    
    tbody.innerHTML = filtered.map(o => {
        const cName = o.courier ? (state.couriers.find(x=>x.code===o.courier)?.name || o.courier) : '-';
        const rowClass = o.type === 'deposit' ? 'row-deposit' : 'row-delivery';
        const typeLabel = o.type === 'deposit' ? 'ğŸ’° Ø¹Ø±Ø¨ÙˆÙ†' : 'ğŸšš ØªÙˆØµÙŠÙ„';
        
        let actionBtn = '';
        if(o.status === 'Ø¬Ø¯ÙŠØ¯') actionBtn = `<button class="btn btn-sm" style="background:#607d8b;color:#fff" onclick="assignCourier('${o.code}')">Ø¥Ø³Ù†Ø§Ø¯</button>`;
        else if(o.status === 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨') actionBtn = `<button class="btn btn-sm btn-primary" onclick="markDelivered('${o.code}')">ÙˆØµÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©</button>`;
        // Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
        else if(o.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…Ø³ØªÙ„Ù…)') actionBtn = `<button class="btn btn-sm btn-primary" onclick="markDelivered('${o.code}')">ÙˆØµÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©</button>`;
        
        else if(o.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') actionBtn = `<button class="btn btn-sm btn-success" onclick="settleOrder('${o.code}')">ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…ÙƒØªØ¨</button>`;
        else actionBtn = '<i class="material-icons" style="color:green">check_circle</i>';

        return `
        <tr class="${rowClass}">
            <td><strong>${o.code}</strong></td>
            <td><small>${typeLabel}</small></td>
            <td>${o.name} <br> <span style="font-size:12px;color:#666">${o.addr}</span></td>
            <td>${o.val}</td>
            <td>${cName}</td>
            <td>${o.status}</td>
            <td><button class="btn btn-sm" style="background:#fff;border:1px solid #ccc" onclick="printSticker('${o.code}')"><i class="material-icons" style="font-size:16px">print</i></button></td>
            <td>${actionBtn}</td>
            <td>${o.status !== 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…ÙƒØªØ¨' ? `<button class="btn btn-sm btn-danger" onclick="deleteOrder('${o.code}')">Ã—</button>` : ''}</td>
        </tr>`;
    }).join('');
}

function renderCouriers() {
    const tbody = document.querySelector('#couriersTable tbody');
    tbody.innerHTML = state.couriers.map(c => `
        <tr>
            <td>${c.name}</td>
            <td>${c.code}</td>
            <td><span class="money-pill money-pos">${c.debt.toFixed(2)}</span></td>
            <td><span class="money-pill money-neg">${c.earnings.toFixed(2)}</span></td>
            <td><button class="btn btn-sm btn-success" onclick="payCourier('${c.code}')">ØµØ±Ù</button></td>
        </tr>
    `).join('');
}

function printSticker(code) {
    const o = state.orders.find(x => x.code === code);
    const cName = o.courier ? (state.couriers.find(c=>c.code===o.courier)?.name || '') : '';
    const html = `
    <!DOCTYPE html><html dir="rtl"><head><style>
        body { margin:0; padding:10px; font-family:'Tahoma'; }
        .sticker { width: 350px; border: 2px solid #000; padding: 10px; border-radius: 8px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
        .cust-name { font-weight: bold; font-size: 18px; }
        .cust-code { font-weight: bold; font-size: 16px; border: 2px solid #000; padding: 2px 8px; }
        .qr-box { text-align: center; margin: 10px 0; }
        .courier-section { margin-top: 10px; border-top: 2px solid #000; padding-top: 5px; text-align: center; font-weight: bold; font-size: 18px; }
    </style></head><body>
        <div class="sticker">
            <div class="header">
                <div class="cust-name">${o.name}</div>
                <div class="cust-code">${o.custCustCode || o.custCode || 'CODE'}</div>
            </div>
            <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${o.addr}</div>
            <div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o.phone}</div>
            <div class="qr-box"><img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${o.code}" style="width:100px;"></div>
            <div class="courier-section">Ù…Ù†Ø¯ÙˆØ¨: ${cName || '--------------'}</div>
        </div>
    </body></html>`;
    const frame = document.getElementById('printFrame');
    frame.srcdoc = html;
    frame.onload = function() { frame.contentWindow.print(); }
}
// ==================== Ù†Ù‡Ø§ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù€ Admin Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ====================

// Ø§Ù„Ø¨Ø¯Ø¡
load();
</script>
</body>
</html>